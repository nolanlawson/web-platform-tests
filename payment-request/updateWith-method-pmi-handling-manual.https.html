<!DOCTYPE html>
<!-- Copyright Â© 2017 Mozilla and World Wide Web Consortium, (Massachusetts Institute of Technology, ERCIM, Keio University, Beihang). -->
<meta charset="utf-8">
<title>Test for validity of payment method identifiers when calling updateWith() method</title>
<link rel="help" href="https://w3c.github.io/browser-payment-api/#constructor">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
"use strict";
setup({ explicit_done: true, explicit_timeout: true });
const validMethod = Object.freeze({
  supportedMethods: "https://:@wpt.fyi:443/payment-request",
});

const validMethods = Object.freeze([validMethod]);

const validAmount = Object.freeze({
  currency: "USD",
  value: "1.0",
});

const validTotal = Object.freeze({
  label: "Default Total",
  amount: validAmount,
});

const validShippingOption = {
  id: "standard",
  label: "Shipping option",
  amount: validAmount,
  selected: true,
};

const validDetails = Object.freeze({
  total: validTotal,
  shippingOptions: [validShippingOption],
});

const validModifier = [
  {
    supportedMethods: "basic-card",
    total: validTotal,
  },
];

// Avoid false positives, this should always pass
function smokeTest() {
  new PaymentRequest(validMethods, validDetails);
}

function manualTest(button, { invalidMethod }) {
  button.disabled = true;
  promise_test(async t => {
    smokeTest();
    const request = new PaymentRequest(
      [{ supportedMethods: "basic-card" }],
      validDetails,
      { requestShipping: true }
    );
    // We test against a valid and an invalid modifier
    // expecting the invalid one to throw the RangeError.
    const shippingChangedPromise = new Promise((resolve, reject) => {
      request.addEventListener(
        "shippingaddresschange",
        ev => {
          const invalidModifier = Object.assign({}, validModifier, {
            supportedMethods: invalidMethod,
          });
          const invalidDetails = Object.assign({}, validDetails, {
            modifiers: [validModifier, invalidModifier],
          });
          try {
            ev.updateWith(invalidDetails);
            resolve(); // This is bad.
          } catch (err) {
            reject(err); // this is good.
          }
        },
        { once: true }
      );
    });
    const showPromise = request.show();
    await promise_rejects(t, new RangeError(), shippingChangedPromise);
    await promise_rejects(t, "AbortError", showPromise);
  }, button.textContent.trim());
}
</script>
<h2>updateWith() method: test validity of payment method identifiers.</h2>
<p>
  When shown a payment sheet, select a different address.
</p>
<ol>
  <li>
    <button onclick="manualTest(this, {invalidMethod: 'https://:password@example.com'});">
      Must throw if the URL has a password.
    </button>
  </li>
      <li>
    <button onclick="manualTest(this, {invalidMethod: 'https://username@example.com'});">
      Must throw if the URL has a username.
    </button>
  </li>
  <li>
    <button onclick="manualTest(this, {invalidMethod: 'https://username:password@example.com/pay'});">
      Must throw if the URL has a username and a password.
    </button>
  </li>
  <li>
    <button onclick="manualTest(this, {invalidMethod: 'http://username:password@example.com/pay'});">
      Must throw if it's http, and has a username and password.
    </button>
  </li>
  <li>
    <button onclick="manualTest(this, {invalidMethod: 'http://foo.com:100000000/pay'});">
      Must throw if the URL is invalid (port range).
    </button>
    </li>
  <li>
    <button onclick="manualTest(this, {invalidMethod: 'basic-ðŸ’³'});">
      Must throw if it contains characters that out of range.
    </button>
  </li>
  <li>
    <button onclick="manualTest(this, {invalidMethod: 'not-https://wpt.fyi/payment-request'});">
      Must throw if not https.
    </button>
  </li>
  <li>
    <button onclick="manualTest(this, {invalidMethod: 'Â¡basic-*-card!'});">
      Must throw if the standardized PMI contains characters outside the ascii range.
    </button>
  </li>
  <li>
    <button onclick="manualTest(this, {invalidMethod: 'Basic-Card'}); done();">
      Must throw if standardized PMI has uppercase characters.
    </button>
  </li>
</ol>
